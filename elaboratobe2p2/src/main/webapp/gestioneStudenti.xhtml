<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Gestione Studenti</title>
</h:head>

<h:body>
    <f:metadata>
        <f:viewAction action="#{studenteBean.init}" />
    </f:metadata>

    <h:form id="form">
        <p:messages id="msg" closable="true" showDetail="false" />

        <!-- Panel per inserimento nuovo studente -->
        <p:panel header="Inserisci Nuovo Studente" style="width: 500px; margin: auto; margin-top: 30px;">
            <h:panelGrid columns="2" style="width: 100%;">
                <p:outputLabel for="nome" value="Nome:" />
                <p:inputText id="nome" value="#{studenteBean.studente.nome}" 
                           style="width: 100%;" required="true" requiredMessage="Il nome è obbligatorio" />

                <p:outputLabel for="cognome" value="Cognome:" />
                <p:inputText id="cognome" value="#{studenteBean.studente.cognome}" 
                           style="width: 100%;" required="true" requiredMessage="Il cognome è obbligatorio" />
            </h:panelGrid>

            <p:separator />

            <div style="display: flex; gap: 1rem;">
                <p:commandButton value="Salva Studente" action="#{studenteBean.salvaStudente}"
                               update="form" icon="pi pi-save" styleClass="ui-button-primary" />
                <p:commandButton value="Reset" action="#{studenteBean.resetForm}"
                               update="form" icon="pi pi-refresh" styleClass="ui-button-secondary" />
            </div>
        </p:panel>

        <!-- Panel per registrazione prova -->
        <p:panel header="Registra Prova" style="width: 600px; margin: auto; margin-top: 30px;">
            <h:panelGrid columns="2" style="width: 100%;">
                <p:outputLabel for="studenteProva" value="Studente:" />
                <p:selectOneMenu id="studenteProva" value="#{studenteBean.studenteSelezionatoId}" style="width: 100%;">
                    <f:selectItem itemLabel="-- Seleziona studente --" itemValue="#{null}" />
                    <f:selectItems value="#{studenteBean.studenti}" var="s"
                                 itemLabel="#{s.nome} #{s.cognome}" itemValue="#{s.id}" />
                </p:selectOneMenu>

                <p:outputLabel for="corsoProva" value="Corso:" />
                <p:selectOneMenu id="corsoProva" value="#{studenteBean.corsoSelezionatoId}" style="width: 100%;">
                    <f:selectItem itemLabel="-- Seleziona corso --" itemValue="#{null}" />
                    <f:selectItems value="#{studenteBean.corsi}" var="c"
                                 itemLabel="#{c.nome}" itemValue="#{c.id}" />
                </p:selectOneMenu>

                <p:outputLabel for="votoProva" value="Voto:" />
                <p:inputText id="votoProva" value="#{studenteBean.voto}" style="width: 100%;" />
            </h:panelGrid>

            <p:separator />

            <p:commandButton value="Registra Prova" action="#{studenteBean.registraProva}"
                           update="form" icon="pi pi-plus" styleClass="ui-button-primary" />
        </p:panel>

        <!-- Tabella studenti -->
        <p:panel header="Lista Studenti" style="margin-top: 30px;">
            <p:dataTable id="studentiTable" value="#{studenteBean.studenti}" var="studente"
                       paginator="true" rows="10" paginatorPosition="bottom"
                       emptyMessage="Nessuno studente trovato">

                <p:column headerText="ID" style="width: 80px;">
                    <h:outputText value="#{studente.id}" />
                </p:column>

                <p:column headerText="Nome" sortBy="#{studente.nome}">
                    <h:outputText value="#{studente.nome}" />
                </p:column>

                <p:column headerText="Cognome" sortBy="#{studente.cognome}">
                    <h:outputText value="#{studente.cognome}" />
                </p:column>

                <p:column headerText="Media Voti">
                    <h:outputText value="#{studenteBean.getMediaVoti(studente)}">
                        <f:convertNumber type="number" maxFractionDigits="2" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Prove Superate">
                    <h:outputText value="#{studenteBean.getNumeroProveSuperateStudente(studente)}" />
                </p:column>

                <p:column headerText="Corsi Mancanti">
                    <h:outputText value="#{studenteBean.getCorsiNonSuperati(studente).size()}" />
                </p:column>

                <p:column headerText="Azioni" style="width: 150px;">
                    <p:commandButton icon="pi pi-pencil" title="Modifica"
                                   action="#{studenteBean.modificaStudente(studente)}"
                                   update="form" styleClass="ui-button-warning" />
                    
                    <p:commandButton icon="pi pi-trash" title="Elimina"
                                   action="#{studenteBean.eliminaStudente(studente)}"
                                   update="form" styleClass="ui-button-danger"
                                   onclick="return confirm('Sei sicuro di voler eliminare questo studente?');" />
                </p:column>

            </p:dataTable>
        </p:panel>

        <!-- Panel dettaglio studente -->
        <p:panel header="Dettaglio Studenti" style="margin-top: 30px;">
            <ui:repeat value="#{studenteBean.studenti}" var="studente">
                <p:panel header="Studente: #{studente.nome} #{studente.cognome}" style="margin-bottom: 20px;">
                    <p><strong>Media Voti:</strong> 
                       <h:outputText value="#{studenteBean.getMediaVoti(studente)}">
                           <f:convertNumber type="number" maxFractionDigits="2" />
                       </h:outputText>
                    </p>
                    
                    <p><strong>Corsi da superare:</strong></p>
                    <ul>
                        <ui:repeat value="#{studenteBean.getCorsiNonSuperati(studente)}" var="corso">
                            <li>#{corso.nome}</li>
                        </ui:repeat>
                    </ul>
                </p:panel>
            </ui:repeat>
        </p:panel>

    </h:form>
</h:body>
</html>